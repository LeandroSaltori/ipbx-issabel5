#!/bin/bash
# Script para modificar o Address Book do Issabel
# Autor: [Seu Nome]
# Data: $(date +%Y-%m-%d)

# Configurações
MODULE_DIR="/var/www/html/modules/address_book"
BACKUP_DIR="/root/address_book_backup_$(date +%Y%m%d%H%M%S)"
TARGET_FILE="Contactmanager.class.php"

# 1. Verificar se o módulo existe
if [ ! -d "$MODULE_DIR" ]; then
    echo "ERRO: Diretório do módulo não encontrado em $MODULE_DIR"
    exit 1
fi

# 2. Criar backup
echo "Criando backup em $BACKUP_DIR..."
mkdir -p "$BACKUP_DIR"
cp "$MODULE_DIR/$TARGET_FILE" "$BACKUP_DIR/" || {
    echo "ERRO: Falha ao criar backup"
    exit 1
}

# 3. Aplicar modificações
echo "Aplicando patch..."
sed -i \
-e "/'last_name' => array('required' => true)/s/true/false/" \
-e "/'last_name' => 'Sobrenome',/,/'name' => 'Nome'/ { /'last_name'/ { h; d }; /'name'/ { x; G } }" \
-e "/\$smarty->assign('status',/s/'isPrivate'/'isPublic'/" \
"$MODULE_DIR/$TARGET_FILE" || {
    echo "ERRO: Falha ao aplicar modificações"
    echo "Restaurando backup..."
    cp "$BACKUP_DIR/$TARGET_FILE" "$MODULE_DIR/$TARGET_FILE"
    exit 1
}

# 4. Limpar cache
echo "Limpando cache..."
rm -f /tmp/smarty_compile/*

# 5. Testar sintaxe PHP
echo "Verificando sintaxe PHP..."
php -l "$MODULE_DIR/$TARGET_FILE" || {
    echo "ERRO: Problema na sintaxe do arquivo modificado"
    echo "Restaurando backup..."
    cp "$BACKUP_DIR/$TARGET_FILE" "$MODULE_DIR/$TARGET_FILE"
    exit 1
}

# 6. Ajustar permissões
echo "Ajustando permissões..."
chown apache:apache "$MODULE_DIR/$TARGET_FILE"
chmod 644 "$MODULE_DIR/$TARGET_FILE"

echo "Patch aplicado com sucesso!"
echo "Reinicie o servidor web para garantir as alterações:"
echo "systemctl restart httpd"
