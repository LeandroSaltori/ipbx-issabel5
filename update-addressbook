#!/bin/bash
# Script de atualização do Address Book para Issabel 5
# Autor: Leandro Saltori
# Repositório: https://github.com/LeandroSaltori/ipbx-issabel5

# Configurações
ISSABEL_MODULES_DIR="/var/www/html/modules"
ADDRESSBOOK_DIR="$ISSABEL_MODULES_DIR/address_book"
BACKUP_DIR="$ISSABEL_MODULES_DIR/address_book_old_$(date +%Y%m%d%H%M%S)"
GITHUB_REPO="https://github.com/LeandroSaltori/ipbx-issabel5/trunk/web/modules/address_book"
LOG_FILE="/var/log/addressbook_update.log"

# Função para registrar logs
log() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" | tee -a "$LOG_FILE"
}

# 1. Verificar ambiente
log "=== INICIANDO ATUALIZAÇÃO DO ADDRESS BOOK ==="
if [ ! -d "$ADDRESSBOOK_DIR" ]; then
    log "ERRO: Diretório do Address Book não encontrado em $ADDRESSBOOK_DIR"
    exit 1
fi

# 2. Parar serviços dependentes
log "Parando serviços relacionados..."
systemctl stop httpd asterisk

# 3. Criar backup completo
log "Criando backup da pasta atual..."
if [ -d "$ADDRESSBOOK_DIR" ]; then
    cp -rp "$ADDRESSBOOK_DIR" "$BACKUP_DIR" && \
    log "Backup criado em: $BACKUP_DIR" || {
        log "ERRO: Falha ao criar backup"
        exit 1
    }
fi

# 4. Baixar nova versão
log "Baixando nova versão do GitHub..."
TEMP_DIR=$(mktemp -d)
svn export "$GITHUB_REPO" "$TEMP_DIR" --force >> "$LOG_FILE" 2>&1 || {
    log "ERRO: Falha ao baixar do GitHub"
    exit 1
}

# 5. Remover versão antiga
log "Removendo versão antiga..."
rm -rf "$ADDRESSBOOK_DIR" || {
    log "ERRO: Falha ao remover pasta antiga"
    exit 1
}

# 6. Instalar nova versão
log "Instalando nova versão..."
mv "$TEMP_DIR" "$ADDRESSBOOK_DIR" && \
chown -R apache:apache "$ADDRESSBOOK_DIR" && \
chmod -R 755 "$ADDRESSBOOK_DIR" || {
    log "ERRO: Falha na instalação"
    exit 1
}

# 7. Aplicar customizações
log "Aplicando customizações..."
sed -i \
-e "/'last_name' => array('required' => true)/s/true/false/" \
-e "/\$smarty->assign('status',/s/'isPrivate'/'isPublic'/" \
"$ADDRESSBOOK_DIR/Contactmanager.class.php"

# 8. Validar instalação
log "Validando instalação..."
php -l "$ADDRESSBOOK_DIR/Contactmanager.class.php" >> "$LOG_FILE" 2>&1 || {
    log "ERRO: Problema na sintaxe PHP - Restaurando backup..."
    rm -rf "$ADDRESSBOOK_DIR"
    mv "$BACKUP_DIR" "$ADDRESSBOOK_DIR"
    exit 1
}

# 9. Limpar cache
log "Limpando cache..."
rm -rf /tmp/smarty_compile/* /var/cache/issabel/*

# 10. Reiniciar serviços
log "Reiniciando serviços..."
systemctl start httpd asterisk

log "=== ATUALIZAÇÃO CONCLUÍDA COM SUCESSO ==="
echo "Detalhes completos em: $LOG_FILE"
echo "Backup disponível em: $BACKUP_DIR"
